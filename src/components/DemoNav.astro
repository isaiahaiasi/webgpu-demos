---
import { demoData } from "../data/demos";

const demos = Object.keys(demoData)
	.map((slug) => ({
		url: `/demos/${slug}`,
		name: slug,
		title: demoData[slug].title,
	}))
	.sort(
		(a, b) =>
			(demoData[a.name]?.order ?? 999) - (demoData[b.name]?.order ?? 999),
	);

const currentPath = Astro.url.pathname;
---

<nav class="demo-nav">
	<button class="menu-close" aria-label="Close menu">
		<span class="close-icon"></span>
	</button>

	<a href="/" class="home-link">Demos</a>

	<div class="demo-links">
		{
			demos.map((demo) => (
				<a
					href={demo.url}
					class:list={[
						"demo-link",
						{ active: currentPath.includes(demo.name) },
					]}
				>
					{demo.title}
				</a>
			))
		}
	</div>
</nav>

<button class="menu-toggle" aria-label="Toggle menu">
	<span class="hamburger"></span>
</button>

<div class="menu-overlay"></div>

<style>
	/* Menu toggle button (FAB) */
	.menu-toggle {
		position: fixed;
		bottom: 1.5rem;
		left: 1.5rem;
		width: 3.5rem;
		height: 3.5rem;
		border-radius: 50%;
		background: rgba(30, 30, 35, 0.95);
		border: 1px solid rgba(255, 255, 255, 0.1);
		cursor: pointer;
		z-index: 10002;
		align-items: center;
		justify-content: center;
		padding: 0;
		margin: 0;
		transition: background 0.2s;
		/* Mobile: always visible. Desktop: hidden by default (visible when menu closed) */
		display: flex;

		&:hover {
			background: rgba(40, 40, 45, 0.95);
		}

		&.is-open .hamburger {
			background: transparent;

			&::before {
				transform: rotate(45deg);
				top: 0;
			}

			&::after {
				transform: rotate(-45deg);
				bottom: 0;
			}
		}

		@media (min-width: 1024px) {
			display: none;

			&.visible {
				display: flex;
				top: 1.5rem;
				bottom: auto;
			}
		}
	}

	/* Hamburger icon */
	.hamburger {
		position: relative;
		width: 1.5rem;
		height: 2px;
		background: rgba(255, 255, 255, 0.9);
		display: block;
		transition: background 0.2s;

		&::before,
		&::after {
			content: "";
			position: absolute;
			width: 100%;
			height: 2px;
			background: rgba(255, 255, 255, 0.9);
			left: 0;
			transition:
				transform 0.2s,
				top 0.2s,
				bottom 0.2s;
		}

		&::before {
			top: -0.5rem;
		}

		&::after {
			bottom: -0.5rem;
		}
	}

	/* Close button inside menu */
	.menu-close {
		position: absolute;
		top: 1rem;
		right: 1rem;
		width: 2.5rem;
		height: 2.5rem;
		background: transparent;
		border: none;
		cursor: pointer;
		padding: 0;
		margin: 0;
		align-items: center;
		justify-content: center;
		/* Mobile: hidden by default. Desktop: hidden by default. Shown by JS when menu is open */
		display: none;

		&:hover {
			background: rgba(255, 255, 255, 0.1);
			border-radius: 4px;
		}

		&.visible {
			display: flex;
		}
	}

	.close-icon {
		position: relative;
		width: 1.25rem;
		height: 1.25rem;

		&::before,
		&::after {
			content: "";
			position: absolute;
			width: 1.25rem;
			height: 2px;
			background: rgba(255, 255, 255, 0.7);
			top: 50%;
			left: 0;
		}

		&::before {
			transform: rotate(45deg);
		}

		&::after {
			transform: rotate(-45deg);
		}
	}

	/* Overlay for mobile */
	.menu-overlay {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.5);
		z-index: 9999;

		&.visible {
			display: block;
		}
	}

	/* Navigation menu */
	.demo-nav {
		position: fixed;
		top: 0;
		left: 0;
		height: 100dvh;
		width: 280px;
		background: rgba(20, 20, 25, 0.98);
		backdrop-filter: blur(10px);
		border-right: 1px solid rgba(255, 255, 255, 0.1);
		display: flex;
		flex-direction: column;
		gap: 2rem;
		padding: 3rem 1.5rem 2rem;
		z-index: 10001;
		overflow-y: auto;
	}

	.home-link {
		color: #667eea;
		text-decoration: none;
		font-weight: 600;
		font-size: 1.1rem;
		padding: 0rem 1rem;
	}

	.demo-links {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		width: 100%;
	}

	.demo-link {
		color: rgba(255, 255, 255, 0.7);
		text-decoration: none;
		padding: 0.75rem 1rem;
		border-radius: 6px;
		transition: all 0.2s;
		font-size: 0.95rem;

		&:hover {
			color: white;
			background: rgba(255, 255, 255, 0.08);
		}

		&.active {
			color: white;
			background: rgba(102, 126, 234, 0.3);
			border-left: 3px solid #667eea;
		}
	}

	/* Mobile: default closed, slide in when user opens */
	@media (max-width: 1023px) {
		.demo-nav {
			transform: translateX(-100%);
			width: 90%;

			&.user-opened {
				transform: translateX(0);
			}
		}
	}

	/* Desktop: default open, hide when user closes */
	@media (min-width: 1024px) {
		.demo-nav {
			position: relative;
			height: auto;
			transform: translateX(0);

			&.user-closed {
				transform: translateX(-100%);
				width: 0;
				padding: 0;
				border: none;
				overflow: hidden;
			}
		}
	}
</style>

<script>
	const DESKTOP_BREAKPOINT = 1024;

	const menuToggle = document.querySelector(".menu-toggle");
	const menuClose = document.querySelector(".menu-close");
	const menu = document.querySelector(".demo-nav");
	const overlay = document.querySelector(".menu-overlay");

	// Three-state tracking: null (default), true (user opened), false (user closed)
	let userInteraction: boolean | null = null;

	function isMobile() {
		return window.innerWidth < DESKTOP_BREAKPOINT;
	}

	function shouldMenuBeOpen() {
		if (userInteraction === null) {
			// Default state: mobile closed, desktop open
			return !isMobile();
		}
		// User has interacted: respect their choice
		return userInteraction;
	}

	function updateUI() {
		const menuOpen = shouldMenuBeOpen();
		const mobile = isMobile();

		// Mobile: add user-opened if user opened it
		// Desktop: add user-closed if user closed it
		// Otherwise: go with default.
		if (userInteraction !== null) {
			if (mobile) {
				menu?.classList.toggle("user-opened", userInteraction);
				menu?.classList.remove("user-closed");
			} else {
				menu?.classList.toggle("user-closed", !userInteraction);
				menu?.classList.remove("user-opened");
			}
		}

		// Update close button (visible when menu is open)
		menuClose?.classList.toggle("visible", menuOpen);

		// Update toggle button
		// Mobile: always visible
		// Desktop: only visible when menu is closed
		const toggleVisible = mobile || !menuOpen;
		menuToggle?.classList.toggle("visible", toggleVisible);
		menuToggle?.classList.toggle("is-open", menuOpen);

		// Update overlay (mobile only, when open)
		overlay?.classList.toggle("visible", mobile && menuOpen);
	}

	function openMenu() {
		userInteraction = true;
		updateUI();
	}

	function closeMenu() {
		userInteraction = false;
		updateUI();
	}

	function toggleMenu() {
		if (shouldMenuBeOpen()) {
			closeMenu();
		} else {
			openMenu();
		}
	}

	// Event listeners
	menuToggle?.addEventListener("click", toggleMenu);
	menuClose?.addEventListener("click", closeMenu);
	overlay?.addEventListener("click", closeMenu);

	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && shouldMenuBeOpen()) {
			closeMenu();
		}
	});

	window.addEventListener("resize", updateUI);

	updateUI();
</script>
